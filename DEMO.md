# COMPASS Demo

Run COMPASS with a complete observability stack in ~10 minutes (first run) or ~2 minutes (subsequent runs).

## Prerequisites

- Docker & Docker Compose
- Python 3.11+ and Poetry
- OpenAI or Anthropic API key
- 8GB RAM available (demo stack uses ~2.5GB)

## Quick Start

### 1. Setup COMPASS

```bash
# Clone and install
git clone <repo>
cd compass
poetry install

# Configure API key
cp .env.example .env
# Edit .env and add OPENAI_API_KEY or ANTHROPIC_API_KEY
```

### 2. Start Demo Environment

```bash
# Start full observability stack + sample app
docker-compose -f docker-compose.observability.yml up -d
```

This starts:
- **Grafana** - http://localhost:3000 (anonymous access, no login)
- **Prometheus** - http://localhost:9090
- **Loki** - http://localhost:3100
- **Tempo** - http://localhost:3200
- **PostgreSQL** - localhost:5432 (demo/demo)
- **postgres-exporter** - Database metrics on port 9187
- **Sample App** - http://localhost:8000 (payment service)

Wait ~30 seconds for all services to be healthy.

### 3. Trigger an Incident

```bash
# Trigger missing index incident (full table scan)
curl -X POST http://localhost:8000/trigger-incident \
  -H "Content-Type: application/json" \
  -d '{"incident_type": "missing_index"}'

# Generate traffic to observe incident
for i in {1..20}; do
  curl -X POST http://localhost:8000/payment \
    -H "Content-Type: application/json" \
    -d '{"amount": 100}'
done
```

### 4. Investigate with COMPASS

```bash
poetry run compass investigate \
  --service payment-service \
  --symptom "slow database queries and high latency" \
  --severity high
```

### 5. Review Post-Mortem

```bash
# View generated post-mortem
ls postmortems/
cat postmortems/*.md
```

## What Happens

1. **Observe**: DatabaseAgent queries Prometheus, Loki, and Tempo for metrics, logs, and traces
2. **Orient**: DatabaseAgent generates hypothesis using LLM based on real observability data
3. **Decide**: You select which hypothesis to validate
4. **Act**: System validates hypothesis with disproof strategies
5. **Result**: Investigation completes with RESOLVED status
6. **Post-mortem**: Markdown document generated with investigation results

## Expected Output

```
=== COMPASS Investigation ===
Service: payment-service
Symptom: slow database queries and high latency
Severity: high

[OBSERVE] Querying 1 specialist agents...
  ✓ database_specialist (confidence: 0.8)
  Metrics: 45 datapoints
  Logs: 12 entries
  Traces: 8 spans

[ORIENT] Generated 1 hypotheses:
  [1] Full table scan due to missing index on amount column (88% confidence)

[DECIDE] Select hypothesis to validate:
> 1

[ACT] Validating hypothesis...
  ✓ temporal_contradiction: Not disproven
  ✓ scope_verification: Not disproven
  ✓ correlation_vs_causation: Not disproven

[RESOLVED] Investigation complete!
  Hypothesis: Full table scan due to missing index on amount column
  Confidence: 92% (initial: 88%)
  Cost: $0.18
  Duration: 6.7s

Post-mortem saved to: postmortems/payment-service-a3b2c1d4-2025-11-18-140532.md
```

## Post-Mortem Documents

After each investigation, COMPASS automatically generates a post-mortem document in markdown format.

### Post-Mortem Location

Post-mortems are saved to the `postmortems/` directory by default:
```
postmortems/payment-service-a3b2c1d4-2025-11-18-140532.md
```

Filename format: `{service}-{investigation-id}-{timestamp}.md`

### Post-Mortem Contents

Post-mortems include:
- Investigation summary (service, symptom, severity, duration, cost)
- Root cause hypothesis with confidence score (for RESOLVED investigations)
- Explanation of INCONCLUSIVE status (when no hypothesis validated)
- Validation results from disproof strategies
- Agent observations and reasoning
- Recommendations based on affected systems

### Example Post-Mortem (RESOLVED)

```markdown
# Post-Mortem: payment-service - high latency and 500 errors

**Generated:** 2025-11-18 14:05:32 UTC
**Investigation ID:** a3b2c1d4-5e6f-7a8b-9c0d-1e2f3a4b5c6d
**Severity:** critical
**Status:** RESOLVED

---

## Summary

**Service:** payment-service
**Symptom:** high latency and 500 errors
**Duration:** 8.2 seconds
**Cost:** $0.2547
**Agents:** 1 specialist agent(s)

---

## Root Cause

**Hypothesis:** Database connection pool exhausted
**Confidence:** 90% (initial: 85%)
**Source:** database_specialist

**Reasoning:**
1 supporting evidence (1 direct); survived 3 disproof attempt(s)

---

## Validation

**Disproof Strategies Applied:**
- ✓ temporal_contradiction: Not disproven
- ✓ scope_verification: Not disproven
- ✓ correlation_vs_causation: Not disproven

**Final Confidence:** 90%

---

## Recommendations

Based on validated hypothesis and affected systems:
- Review and remediate payment-db

---

*Generated by COMPASS on 2025-11-18 14:05:32 UTC*
```

### Configuration Options

```bash
# Save to custom directory
poetry run compass investigate \
  --service payment-service \
  --symptom "high latency" \
  --severity critical \
  --output-dir ./reports

# Skip post-mortem generation (for testing)
poetry run compass investigate \
  --service payment-service \
  --symptom "high latency" \
  --severity critical \
  --skip-postmortem
```

## Available Incidents

The sample app supports multiple realistic incident scenarios:

```bash
# Missing index (full table scan)
curl -X POST http://localhost:8000/trigger-incident \
  -H "Content-Type: application/json" \
  -d '{"incident_type": "missing_index"}'

# Lock contention (hold row locks for 2 seconds)
curl -X POST http://localhost:8000/trigger-incident \
  -H "Content-Type: application/json" \
  -d '{"incident_type": "lock_contention"}'

# Connection pool exhaustion (hold connections for 5 seconds)
curl -X POST http://localhost:8000/trigger-incident \
  -H "Content-Type: application/json" \
  -d '{"incident_type": "pool_exhaustion"}'

# Return to normal operation
curl -X POST http://localhost:8000/trigger-incident \
  -H "Content-Type: application/json" \
  -d '{"incident_type": "normal"}'
```

## Troubleshooting

### Services won't start
```bash
# Check logs
docker-compose -f docker-compose.observability.yml logs

# Restart everything
docker-compose -f docker-compose.observability.yml down
docker-compose -f docker-compose.observability.yml up -d
```

### No metrics in Grafana
```bash
# Verify Prometheus is scraping
curl http://localhost:9090/api/v1/targets

# Check sample app is running
curl http://localhost:8000/health
```

### Port conflicts
If ports 3000, 9090, 3100, 3200, 5432, or 8000 are already in use:
- Stop conflicting services
- OR modify port mappings in docker-compose.observability.yml

### No LLM provider configured
```
⚠️  OpenAI API key not configured. Set OPENAI_API_KEY environment variable.
```
→ Edit .env and add OPENAI_API_KEY or ANTHROPIC_API_KEY

### Investigation INCONCLUSIVE
→ Check that API key is valid and has sufficient credits
→ Verify demo environment is running (docker-compose ps)

### Permission denied or module not found
```bash
# Ensure you're in the poetry shell
poetry shell

# Or use poetry run prefix
poetry run compass investigate --help
```

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `OPENAI_API_KEY` | OpenAI API key | None |
| `ANTHROPIC_API_KEY` | Anthropic API key | None |
| `DEFAULT_LLM_PROVIDER` | LLM provider to use | `openai` |
| `DEFAULT_MODEL_NAME` | Model for worker agents | `gpt-4o-mini` |
| `DEFAULT_COST_BUDGET_USD` | Budget for low/medium/high severity | `10.0` |
| `CRITICAL_COST_BUDGET_USD` | Budget for critical severity | `20.0` |

### Severity Levels

- **low/medium/high**: Uses `DEFAULT_COST_BUDGET_USD` ($10.00)
- **critical**: Uses `CRITICAL_COST_BUDGET_USD` ($20.00)

## Example Investigations

### Database Performance Issue
```bash
poetry run compass investigate \
  --service postgres-db \
  --symptom "slow queries and high CPU" \
  --severity high
```

### API Latency Spike
```bash
poetry run compass investigate \
  --service api-backend \
  --symptom "p99 latency increased 5x" \
  --severity critical
```

### Microservice Communication Failure
```bash
poetry run compass investigate \
  --service order-service \
  --symptom "timeout errors calling payment service" \
  --severity medium
```

## Clean Up

When done with the demo:

```bash
# Stop all services
docker-compose -f docker-compose.observability.yml down

# Remove volumes (deletes all data)
docker-compose -f docker-compose.observability.yml down -v
```

## Next Steps

- See [README.md](README.md) for full documentation
- Run integration tests: `poetry run pytest -v -m demo`
- Try different incident scenarios (see "Available Incidents" above)
- Check [observability/README.md](observability/README.md) for advanced configuration
